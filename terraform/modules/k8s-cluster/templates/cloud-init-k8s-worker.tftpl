#cloud-config
users:
  - name: ${admin_user}
    groups: users, admin
    sudo: ALL=(ALL) NOPASSWD:ALL
    shell: /bin/bash
    ssh_authorized_keys:
      - ${admin_public_ssh_key}
  - name: terraform
    groups: users, admin
    sudo: ALL=(ALL) NOPASSWD:ALL
    ssh_authorized_keys:
      - ${terraform_public_ssh_key}
package_update: true
package_upgrade: true
package_reboot_if_required: true
write_files:
  - owner: root:root
    content: "${microk8s_config}"
    path: /run/tmpfiles.d/microk8s.yaml
    encoding: base64
    defer: true
  - owner: root:root
    content: "${snapcraft}"
    path: /run/tmpfiles.d/snapcraft.yaml
    encoding: base64
    defer: true
  - owner: root:root
    content: "${packages_setup}"
    path: /run/tmpfiles.d/install-packages.sh
    encoding: base64
    defer: true
  - owner: root:root
    content: "${firewall_setup}"
    path: /run/tmpfiles.d/firewall-setup.sh
    encoding: base64
    defer: true
  - owner: root:root
    content: "${ssh_setup}"
    path: /run/tmpfiles.d/ssh-setup.sh
    encoding: base64
    defer: true
  - owner: root:root
    content: "${microk8s_setup}"
    path: /run/tmpfiles.d/microk8s-setup.sh
    encoding: base64
    defer: true
runcmd:
  - install /run/tmpfiles.d/*.sh /usr/local/bin
  - /usr/local/bin/install-packages.sh
  - /usr/local/bin/firewall-setup.sh
  - /usr/local/bin/ssh-setup.sh
  - /usr/local/bin/microk8s-setup.sh

